<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>교수용 출석 관리</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
<div class="container teacher-container">
    <div class="title">교수용 출석 관리</div>
    <div class="subtitle">출석 코드 생성 · 출석 현황 · IP 주소 확인</div>

    <!-- 탭 (지금은 출석 코드 생성만 활성화) -->
    <div class="tab-row">
        <div class="tab active">출석 코드 생성</div>
    </div>

    <!-- 코드 생성 폼 -->
    <div class="section-card">
        <div class="section-title">출석 코드 생성</div>

        <form method="post" action="/teacher/create-code" class="form-row">
            <div class="form-field">
                <div class="label">수업 날짜</div>
                <input type="date" name="session_date" class="input-box" required>
            </div>

            <div class="form-field">
                <div class="label">유효 시간 (분)</div>
                <input type="number" name="minutes_valid" class="input-box" value="10" min="1">
            </div>

            <button type="submit" class="button-main wide">
                6자리 출석 코드 생성
            </button>
        </form>
    </div>

    <!-- 현재 유효한 출석 코드 -->
    <div class="section-card">
        <div class="section-header">
            <div class="section-title">현재 유효한 출석 코드</div>
            <div class="section-sub">※ 코드 클릭 시 출석 현황 상세 화면으로 이동합니다.</div>
        </div>
        <table class="table">
            <thead>
            <tr>
                <th>수업 날짜</th>
                <th>출석 코드</th>
                <th>유효 종료</th>
                <th>남은 시간</th>
            </tr>
            </thead>
            <tbody>
            {% if active_codes and active_codes|length > 0 %}
                {% for c in active_codes %}
                    <tr class="clickable-row"
                        onclick="location.href='/teacher/code/{{ c._id }}'">
                        <td>{{ c.session_date }}</td>
                        <td class="code-strong">{{ c.attendance_code }}</td>
                        <td>{{ c.valid_until.strftime("%m/%d %H:%M") }}</td>
                        <td>
                            <span class="timer"
                                  data-deadline="{{ c.valid_until.isoformat() }}">
                                계산 중...
                            </span>
                        </td>
                    </tr>
                {% endfor %}
            {% else %}
                <tr><td colspan="4" class="empty-row">현재 유효한 출석 코드가 없습니다.</td></tr>
            {% endif %}
            </tbody>
        </table>
    </div>

    <!-- 지난 출석 -->
    <div class="section-card">
        <div class="section-header">
            <div class="section-title">지난 출석</div>
            <div class="section-sub">※ 지난 출석 코드를 클릭하면 해당 시점의 출석 기록과 IP 로그를 확인할 수 있습니다.</div>
        </div>
        <table class="table">
            <thead>
            <tr>
                <th>수업 날짜</th>
                <th>출석 코드</th>
                <th>유효 종료</th>
            </tr>
            </thead>
            <tbody>
            {% if past_codes and past_codes|length > 0 %}
                {% for c in past_codes %}
                    <tr class="clickable-row"
                        onclick="location.href='/teacher/code/{{ c._id }}'">
                        <td>{{ c.session_date }}</td>
                        <td class="code-strong">{{ c.attendance_code }}</td>
                        <td>{{ c.valid_until.strftime("%m/%d %H:%M") }}</td>
                    </tr>
                {% endfor %}
            {% else %}
                <tr><td colspan="3" class="empty-row">지난 출석 코드 내역이 없습니다.</td></tr>
            {% endif %}
            </tbody>
        </table>
    </div>
</div>

<!-- 리스트 타이머 스크립트 -->
<script>
    (function () {
        const timers = document.querySelectorAll(".timer");
        if (!timers.length) return;

        function updateAll() {
            const now = new Date();
            timers.forEach(t => {
                const deadlineStr = t.dataset.deadline;
                if (!deadlineStr) return;

                const deadline = new Date(deadlineStr);
                const diff = deadline - now;
                if (diff <= 0) {
                    t.textContent = "만료됨";
                    t.classList.add("timer-expired");
                    return;
                }
                const totalSec = Math.floor(diff / 1000);
                const min = String(Math.floor(totalSec / 60)).padStart(2, "0");
                const sec = String(totalSec % 60).padStart(2, "0");
                t.textContent = `${min}:${sec}`;
            });
        }

        updateAll();
        setInterval(updateAll, 1000);
    })();
</script>

</body>
</html>