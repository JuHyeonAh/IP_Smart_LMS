<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>교수용 출석 관리</title>
    <link rel="stylesheet" href="/static/style.css">

    <!-- 모드 토글용 간단 스타일 -->
    <style>
        .mode-toggle {
            display: flex;
            gap: 8px;
            margin: 8px 0 16px 0;
        }
        .mode-btn {
            flex: 1;
            padding: 10px 0;
            border-radius: 999px;
            border: 1px solid #e1e5ee;
            background: #f5f7fb;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }
        .mode-btn.active {
            background: #007bff;
            color: #fff;
            border-color: #007bff;
        }

        /* QR 모드 카드 스타일 */
        .qr-card {
            background: #ffffff;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.04);
        }
        .qr-actions {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin: 12px 0 16px 0;
        }
        .qr-primary-btn,
        .qr-secondary-btn {
            display: inline-block;
            text-align: center;
            padding: 10px 16px;
            border-radius: 8px;
            font-weight: 600;
            text-decoration: none;
        }
        .qr-primary-btn {
            background: #007bff;
            color: #fff;
        }
        .qr-secondary-btn {
            background: #f1f3f7;
            color: #333;
        }
        .qr-hint-box {
            padding: 10px 12px;
            background: #f8fafc;
            border-radius: 8px;
            border: 1px solid #e1e5ee;
            font-size: 13px;
            color: #555;
        }
        .qr-note {
            margin-top: 4px;
            font-size: 12px;
            color: #888;
        }
    </style>
</head>
<body>
<div class="container teacher-container">
    <div class="title">교수용 출석 관리</div>

    <!-- 출석 방식 선택 -->
    <div class="mode-toggle">
        <button class="mode-btn active" data-mode="code">출석 코드</button>
        <button class="mode-btn" data-mode="qr">출석 QR</button>
    </div>

    <div class="subtitle">출석 코드 생성 · 출석 현황 · IP 주소 확인</div>

    <!-- ================= 코드 모드 ================= -->
    <div id="code-mode">
        <!-- 탭 (지금은 출석 코드 생성만 활성화) -->
        <div class="tab-row">
            <div class="tab active">출석 코드 생성</div>
        </div>

        <!-- 코드 생성 폼 -->
        <div class="section-card">
            <div class="section-title">출석 코드 생성</div>

            <form method="post" action="/teacher/create-code" class="form-row">
                <div class="form-field">
                    <div class="label">수업 날짜</div>
                    <input type="date" name="session_date" class="input-box" required>
                </div>

                <div class="form-field">
                    <div class="label">유효 시간 (분)</div>
                    <input type="number" name="minutes_valid" class="input-box" value="10" min="1">
                </div>

                <button type="submit" class="button-main wide">
                    6자리 출석 코드 생성
                </button>
            </form>
        </div>

        <!-- 현재 유효한 출석 코드 -->
        <div class="section-card">
            <div class="section-header">
                <div class="section-title">현재 유효한 출석 코드</div>
                <div class="section-sub">※ 코드 클릭 시 출석 현황 상세 화면으로 이동합니다.</div>
            </div>
            <table class="table">
                <thead>
                <tr>
                    <th>수업 날짜</th>
                    <th>출석 코드</th>
                    <th>유효 종료</th>
                    <th>남은 시간</th>
                </tr>
                </thead>
                <tbody>
                {% if active_codes and active_codes|length > 0 %}
                    {% for c in active_codes %}
                        <tr class="clickable-row"
                            onclick="location.href='/teacher/code/{{ c._id }}'">
                            <td>{{ c.session_date }}</td>
                            <td class="code-strong">{{ c.attendance_code }}</td>
                            <td>{{ c.valid_until.strftime("%m/%d %H:%M") }}</td>
                            <td>
                                <span class="timer"
                                      data-deadline="{{ c.valid_until.isoformat() }}">
                                    계산 중...
                                </span>
                            </td>
                        </tr>
                    {% endfor %}
                {% else %}
                    <tr><td colspan="4" class="empty-row">현재 유효한 출석 코드가 없습니다.</td></tr>
                {% endif %}
                </tbody>
            </table>
        </div>

        <!-- 지난 출석 -->
        <div class="section-card">
            <div class="section-header">
                <div class="section-title">지난 출석</div>
                <div class="section-sub">※ 지난 출석 코드를 클릭하면 해당 시점의 출석 기록과 IP 로그를 확인할 수 있습니다.</div>
            </div>
            <table class="table">
                <thead>
                <tr>
                    <th>수업 날짜</th>
                    <th>출석 코드</th>
                    <th>유효 종료</th>
                </tr>
                </thead>
                <tbody>
                {% if past_codes and past_codes|length > 0 %}
                    {% for c in past_codes %}
                        <tr class="clickable-row"
                            onclick="location.href='/teacher/code/{{ c._id }}'">
                            <td>{{ c.session_date }}</td>
                            <td class="code-strong">{{ c.attendance_code }}</td>
                            <td>{{ c.valid_until.strftime("%m/%d %H:%M") }}</td>
                        </tr>
                    {% endfor %}
                {% else %}
                    <tr><td colspan="3" class="empty-row">지난 출석 코드 내역이 없습니다.</td></tr>
                {% endif %}
                </tbody>
            </table>
        </div>
    </div>
    <!-- =============== 코드 모드 끝 =============== -->

    <!-- =============== QR 모드 =================== -->
    <div id="qr-mode" style="display:none;">
        <div class="qr-card">
            <div class="section-title">출석 QR 방식</div>
            <div class="section-sub">
                학생이 QR 코드를 찍으면, QR 서버가 <strong>암호화된 토큰과 서버 수신 시간</strong>을 로그로 저장합니다.
                교수용 QR 페이지에서 <strong>지연 시간 / 의심 여부</strong>를 확인할 수 있습니다.
            </div>

            <div class="qr-actions">
                <!-- 교수용 QR 생성 페이지 -->
                <a class="qr-primary-btn"
                   href="{{ qr_base_url }}generator"
                   target="_blank">
                    교수용 출석 QR 생성 페이지 열기
                </a>

                <!-- 학생 참여용 링크 설명 -->
                <a class="qr-primary-btn"
                   href="{{ qr_base_url }}attend"
                   target="_blank">
                    학생용 출석 페이지 열기
                </a>
            </div>

            <p class="qr-note">
                ⚠ QR 출석은 별도의 Node.js 서버에서 동작합니다.<br>
                IP 기반 출석과는 독립적으로 동작하므로, 필요에 따라 둘 중 하나만 사용하거나 병행 사용할 수 있습니다.
            </p>
        </div>
    </div>
    <!-- =============== QR 모드 끝 ================= -->
</div>

<!-- 리스트 타이머 스크립트 (코드 모드용) -->
<script>
    (function () {
        const timers = document.querySelectorAll(".timer");
        if (!timers.length) return;

        function updateAll() {
            const now = new Date();
            timers.forEach(t => {
                const deadlineStr = t.dataset.deadline;
                if (!deadlineStr) return;

                const deadline = new Date(deadlineStr);
                const diff = deadline - now;
                if (diff <= 0) {
                    t.textContent = "만료됨";
                    t.classList.add("timer-expired");
                    return;
                }
                const totalSec = Math.floor(diff / 1000);
                const min = String(Math.floor(totalSec / 60)).padStart(2, "0");
                const sec = String(totalSec % 60).padStart(2, "0");
                t.textContent = `${min}:${sec}`;
            });
        }

        updateAll();
        setInterval(updateAll, 1000);
    })();
</script>

<!-- 코드 / QR 모드 토글 스크립트 -->
<script>
    (function () {
        const modeButtons = document.querySelectorAll('.mode-btn');
        const codeMode = document.getElementById('code-mode');
        const qrMode = document.getElementById('qr-mode');

        modeButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                const mode = btn.dataset.mode;

                modeButtons.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');

                if (mode === 'code') {
                    codeMode.style.display = '';
                    qrMode.style.display = 'none';
                } else {
                    codeMode.style.display = 'none';
                    qrMode.style.display = '';
                }
            });
        });
    })();
</script>

</body>
</html>